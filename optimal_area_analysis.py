# ============================================================
# –ë–õ–û–ö 4: –ê–ù–ê–õ–ò–ó –û–ü–¢–ò–ú–ê–õ–¨–ù–û–ô –ü–õ–û–©–ê–î–ò –ú–ê–ì–ê–ó–ò–ù–ê
# ============================================================
# –≠—Ç–æ—Ç –∫–æ–¥ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ notebook store_analytics.ipynb
# ============================================================

"""
üìê –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –û–ü–¢–ò–ú–ê–õ–¨–ù–û–ô –ü–õ–û–©–ê–î–ò –ú–ê–ì–ê–ó–ò–ù–ê

4 –º–µ—Ç–æ–¥–∞ –∞–Ω–∞–ª–∏–∑–∞:
1. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ –º¬≤ (–º–∞–∫—Å–∏–º–∏–∑–∞—Ü–∏—è –≤—ã—Ä—É—á–∫–∏/–º¬≤ –∏ –ø—Ä–∏–±—ã–ª–∏/–º¬≤)
2. –ù–µ–ª–∏–Ω–µ–π–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è (–ø–æ–∏—Å–∫ —Ç–æ—á–∫–∏ —É–±—ã–≤–∞—é—â–µ–π –æ—Ç–¥–∞—á–∏)
3. –ü—Ä–µ–¥–µ–ª—å–Ω–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑)
4. –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è + –±–µ–Ω—á–º–∞—Ä–∫–∏–Ω–≥ (–ª–∏–¥–µ—Ä—ã –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º)
"""

# ============================================================
# 4.0 –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –û –ü–õ–û–©–ê–î–ò
# ============================================================

print("="*80)
print("üìê –ë–õ–û–ö 4: –ê–ù–ê–õ–ò–ó –û–ü–¢–ò–ú–ê–õ–¨–ù–û–ô –ü–õ–û–©–ê–î–ò –ú–ê–ì–ê–ó–ò–ù–ê")
print("="*80)

# –í–ê–ñ–ù–û: –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å –ø–ª–æ—â–∞–¥—è–º–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤
# –§–æ—Ä–º–∞—Ç: –ø–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - "–ú–∞–≥–∞–∑–∏–Ω" –∏–ª–∏ –∞–¥—Ä–µ—Å, –≤—Ç–æ—Ä–∞—è - "–ü–ª–æ—â–∞–¥—å"
STORE_AREA_FILE = 'store.xlsx'  # ‚Üê –ò–ó–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–®–ï –ò–ú–Ø –§–ê–ô–õ–ê

try:
    # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ —Å –ø–ª–æ—â–∞–¥—è–º–∏
    df_area = pd.read_excel(STORE_AREA_FILE)

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    col_names = df_area.columns.tolist()
    print(f"‚úì –ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª: {STORE_AREA_FILE}")
    print(f"  –ö–æ–ª–æ–Ω–∫–∏: {col_names}")

    # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏–∏
    # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º: 1-—è –∫–æ–ª–æ–Ω–∫–∞ = –∞–¥—Ä–µ—Å/–º–∞–≥–∞–∑–∏–Ω, 2-—è = –ø–ª–æ—â–∞–¥—å
    df_area.columns = ['–ú–∞–≥–∞–∑–∏–Ω_–∞–¥—Ä–µ—Å', '–ü–ª–æ—â–∞–¥—å_–º2'] + col_names[2:]

    print(f"\n–ü–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ —Ñ–∞–π–ª–∞:")
    display(df_area.head())

except FileNotFoundError:
    print(f"‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª '{STORE_AREA_FILE}' –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    print(f"\n–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:")
    print(f"1. –ü–æ–ª–æ–∂–∏—Ç–µ —Ñ–∞–π–ª —Å –ø–ª–æ—â–∞–¥—è–º–∏ –≤ —Ç—É –∂–µ –ø–∞–ø–∫—É, —á—Ç–æ –∏ notebook")
    print(f"2. –ò–∑–º–µ–Ω–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é STORE_AREA_FILE –Ω–∞ –∏–º—è –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞")
    print(f"3. –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞:")
    print(f"   –ö–æ–ª–æ–Ω–∫–∞ 1: –ê–¥—Ä–µ—Å –º–∞–≥–∞–∑–∏–Ω–∞ (–¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å '–ú–∞–≥–∞–∑–∏–Ω' –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)")
    print(f"   –ö–æ–ª–æ–Ω–∫–∞ 2: –ü–ª–æ—â–∞–¥—å (–º¬≤)")
    raise

# ============================================================
# 4.1 –û–ë–™–ï–î–ò–ù–ï–ù–ò–ï –î–ê–ù–ù–´–•
# ============================================================

# –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –ø—Ä–æ–¥–∞–∂–∏ –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º (–∑–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥)
store_summary = df.groupby('–ú–∞–≥–∞–∑–∏–Ω').agg({
    '–í—ã—Ä—É—á–∫–∞': 'sum',
    '–í–∞–ª–æ–≤–∞—è_–ø—Ä–∏–±—ã–ª—å': 'sum',
    '–ß–∏—Å–ª–æ —á–µ–∫–æ–≤': 'sum',
    '–ú–∞—Ä–∂–∞_%': 'mean',
    'Store_ID': 'first'
}).reset_index()

# –ü—ã—Ç–∞–µ–º—Å—è —Å–º–µ—Ä–∂–∏—Ç—å –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –º–∞–≥–∞–∑–∏–Ω–∞
# –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è, –ø—Ä–æ–±—É–µ–º –ø–æ –∞–¥—Ä–µ—Å—É
df_area['–ú–∞–≥–∞–∑–∏–Ω'] = df_area['–ú–∞–≥–∞–∑–∏–Ω_–∞–¥—Ä–µ—Å']

# –ú–µ—Ä–∂ –¥–∞–Ω–Ω—ã—Ö
store_with_area = store_summary.merge(
    df_area[['–ú–∞–≥–∞–∑–∏–Ω', '–ü–ª–æ—â–∞–¥—å_–º2']],
    on='–ú–∞–≥–∞–∑–∏–Ω',
    how='left'
)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –º–µ—Ä–∂–∞
missing_area = store_with_area['–ü–ª–æ—â–∞–¥—å_–º2'].isna().sum()
if missing_area > 0:
    print(f"\n‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –î–ª—è {missing_area} –º–∞–≥–∞–∑–∏–Ω–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–ª–æ—â–∞–¥—å!")
    print("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–æ–≤ —Å–æ–≤–ø–∞–¥–∞—é—Ç –≤ –æ–±–æ–∏—Ö —Ñ–∞–π–ª–∞—Ö:")
    print("\n–ú–∞–≥–∞–∑–∏–Ω—ã –±–µ–∑ –ø–ª–æ—â–∞–¥–∏:")
    print(store_with_area[store_with_area['–ü–ª–æ—â–∞–¥—å_–º2'].isna()]['–ú–∞–≥–∞–∑–∏–Ω'].tolist())
    print("\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –≤ —Ñ–∞–π–ª–µ –ø–ª–æ—â–∞–¥–µ–π:")
    print(df_area['–ú–∞–≥–∞–∑–∏–Ω_–∞–¥—Ä–µ—Å'].tolist())

    # –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
    print("\nüîß –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è...")
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –º–∞–≥–∞–∑–∏–Ω–∞ –∏–∑ –æ–±–µ–∏—Ö —Ç–∞–±–ª–∏—Ü
    store_with_area['temp_id'] = store_with_area['–ú–∞–≥–∞–∑–∏–Ω'].str.extract(r'(\d+)').astype(float)
    df_area['temp_id'] = df_area['–ú–∞–≥–∞–∑–∏–Ω_–∞–¥—Ä–µ—Å'].str.extract(r'(\d+)').astype(float)

    # –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –º–µ—Ä–∂ –ø–æ –Ω–æ–º–µ—Ä—É
    store_with_area = store_with_area.drop(columns=['–ü–ª–æ—â–∞–¥—å_–º2'], errors='ignore')
    store_with_area = store_with_area.merge(
        df_area[['temp_id', '–ü–ª–æ—â–∞–¥—å_–º2']],
        on='temp_id',
        how='left'
    )
    store_with_area = store_with_area.drop(columns=['temp_id'])

    missing_after = store_with_area['–ü–ª–æ—â–∞–¥—å_–º2'].isna().sum()
    if missing_after == 0:
        print("‚úì –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!")
    else:
        print(f"‚ùå –û—Å—Ç–∞–ª–∏—Å—å –º–∞–≥–∞–∑–∏–Ω—ã –±–µ–∑ –ø–ª–æ—â–∞–¥–∏: {missing_after}")

# –£–¥–∞–ª—è–µ–º –º–∞–≥–∞–∑–∏–Ω—ã –±–µ–∑ –ø–ª–æ—â–∞–¥–∏
store_with_area = store_with_area.dropna(subset=['–ü–ª–æ—â–∞–¥—å_–º2'])

print(f"\n‚úì –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: {len(store_with_area)} –º–∞–≥–∞–∑–∏–Ω–æ–≤ —Å –ø–ª–æ—â–∞–¥—å—é")
print(f"  –°—Ä–µ–¥–Ω—è—è –ø–ª–æ—â–∞–¥—å: {store_with_area['–ü–ª–æ—â–∞–¥—å_–º2'].mean():.1f} –º¬≤")
print(f"  –î–∏–∞–ø–∞–∑–æ–Ω: {store_with_area['–ü–ª–æ—â–∞–¥—å_–º2'].min():.1f} - {store_with_area['–ü–ª–æ—â–∞–¥—å_–º2'].max():.1f} –º¬≤")

# –†–∞—Å—á—ë—Ç –±–∞–∑–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫
store_with_area['–í—ã—Ä—É—á–∫–∞_–Ω–∞_–º2'] = store_with_area['–í—ã—Ä—É—á–∫–∞'] / store_with_area['–ü–ª–æ—â–∞–¥—å_–º2']
store_with_area['–ü—Ä–∏–±—ã–ª—å_–Ω–∞_–º2'] = store_with_area['–í–∞–ª–æ–≤–∞—è_–ø—Ä–∏–±—ã–ª—å'] / store_with_area['–ü–ª–æ—â–∞–¥—å_–º2']
store_with_area['–¢—Ä–∞—Ñ–∏–∫_–Ω–∞_–º2'] = store_with_area['–ß–∏—Å–ª–æ —á–µ–∫–æ–≤'] / store_with_area['–ü–ª–æ—â–∞–¥—å_–º2']

display(store_with_area.sort_values('Store_ID').round(0))


# ============================================================
# –ú–ï–¢–û–î 1: –ê–ù–ê–õ–ò–ó –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò –ù–ê –ú¬≤
# ============================================================

print("\n" + "="*80)
print("üìä –ú–ï–¢–û–î 1: –ê–ù–ê–õ–ò–ó –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò –ù–ê –ú¬≤")
print("="*80)
print("–¶–µ–ª—å: –ù–∞–π—Ç–∏ –ø–ª–æ—â–∞–¥—å —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –≤—ã—Ä—É—á–∫–æ–π/–º¬≤ –∏ –ø—Ä–∏–±—ã–ª—å—é/–º¬≤\n")

# –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
top_by_revenue_m2 = store_with_area.nlargest(5, '–í—ã—Ä—É—á–∫–∞_–Ω–∞_–º2')[['–ú–∞–≥–∞–∑–∏–Ω', '–ü–ª–æ—â–∞–¥—å_–º2', '–í—ã—Ä—É—á–∫–∞_–Ω–∞_–º2', '–ü—Ä–∏–±—ã–ª—å_–Ω–∞_–º2']]
top_by_profit_m2 = store_with_area.nlargest(5, '–ü—Ä–∏–±—ã–ª—å_–Ω–∞_–º2')[['–ú–∞–≥–∞–∑–∏–Ω', '–ü–ª–æ—â–∞–¥—å_–º2', '–ü—Ä–∏–±—ã–ª—å_–Ω–∞_–º2', '–í—ã—Ä—É—á–∫–∞_–Ω–∞_–º2']]

print("üèÜ –¢–û–ü-5 –ø–æ –≤—ã—Ä—É—á–∫–µ –Ω–∞ –º¬≤:")
display(top_by_revenue_m2.round(0))

print("\nüèÜ –¢–û–ü-5 –ø–æ –ø—Ä–∏–±—ã–ª–∏ –Ω–∞ –º¬≤:")
display(top_by_profit_m2.round(0))

# –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å = —Å—Ä–µ–¥–Ω—è—è –ø–ª–æ—â–∞–¥—å –ª–∏–¥–µ—Ä–æ–≤
optimal_area_method1_revenue = top_by_revenue_m2['–ü–ª–æ—â–∞–¥—å_–º2'].mean()
optimal_area_method1_profit = top_by_profit_m2['–ü–ª–æ—â–∞–¥—å_–º2'].mean()

print(f"\nüí° –í–´–í–û–î –ú–ï–¢–û–î–ê 1:")
print(f"  ‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å (–ø–æ –≤—ã—Ä—É—á–∫–µ/–º¬≤): {optimal_area_method1_revenue:.0f} –º¬≤")
print(f"  ‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å (–ø–æ –ø—Ä–∏–±—ã–ª–∏/–º¬≤): {optimal_area_method1_profit:.0f} –º¬≤")
print(f"  ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω: {top_by_revenue_m2['–ü–ª–æ—â–∞–¥—å_–º2'].min():.0f}-{top_by_revenue_m2['–ü–ª–æ—â–∞–¥—å_–º2'].max():.0f} –º¬≤")

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
fig = px.scatter(
    store_with_area,
    x='–ü–ª–æ—â–∞–¥—å_–º2',
    y='–í—ã—Ä—É—á–∫–∞_–Ω–∞_–º2',
    size='–í—ã—Ä—É—á–∫–∞',
    color='–ü—Ä–∏–±—ã–ª—å_–Ω–∞_–º2',
    text='Store_ID',
    title='üìä –ú–µ—Ç–æ–¥ 1: –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –≤—ã—Ä—É—á–∫–∏/–º¬≤ –æ—Ç –ø–ª–æ—â–∞–¥–∏ –º–∞–≥–∞–∑–∏–Ω–∞',
    labels={'–ü–ª–æ—â–∞–¥—å_–º2': '–ü–ª–æ—â–∞–¥—å (–º¬≤)', '–í—ã—Ä—É—á–∫–∞_–Ω–∞_–º2': '–í—ã—Ä—É—á–∫–∞ –Ω–∞ –º¬≤ (—Ä—É–±)', '–ü—Ä–∏–±—ã–ª—å_–Ω–∞_–º2': '–ü—Ä–∏–±—ã–ª—å/–º¬≤'},
    color_continuous_scale='RdYlGn'
)

# –î–æ–±–∞–≤–ª—è–µ–º –ª–∏–Ω–∏—é –æ–ø—Ç–∏–º—É–º–∞
fig.add_vline(x=optimal_area_method1_revenue, line_dash="dash", line_color="red",
              annotation_text=f"–û–ø—Ç–∏–º—É–º: {optimal_area_method1_revenue:.0f} –º¬≤")

fig.update_traces(textposition='top center')
fig.update_layout(height=500)
fig.show()


# ============================================================
# –ú–ï–¢–û–î 2: –ù–ï–õ–ò–ù–ï–ô–ù–ê–Ø –†–ï–ì–†–ï–°–°–ò–Ø (–ü–û–ò–°–ö –¢–û–ß–ö–ò –ü–ï–†–ï–ì–ò–ë–ê)
# ============================================================

print("\n" + "="*80)
print("üìà –ú–ï–¢–û–î 2: –ù–ï–õ–ò–ù–ï–ô–ù–ê–Ø –†–ï–ì–†–ï–°–°–ò–Ø")
print("="*80)
print("–¶–µ–ª—å: –ù–∞–π—Ç–∏ —Ç–æ—á–∫—É —É–±—ã–≤–∞—é—â–µ–π –æ—Ç–¥–∞—á–∏ (–≥–¥–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å –¥–∞—ë—Ç <10% –ø—Ä–∏—Ä–æ—Å—Ç–∞)\n")

from sklearn.linear_model import LinearRegression
from sklearn.preprocessing import PolynomialFeatures
from sklearn.metrics import r2_score

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
X = store_with_area['–ü–ª–æ—â–∞–¥—å_–º2'].values.reshape(-1, 1)
y_revenue = store_with_area['–í—ã—Ä—É—á–∫–∞'].values
y_profit = store_with_area['–í–∞–ª–æ–≤–∞—è_–ø—Ä–∏–±—ã–ª—å'].values

# 1. –õ–∏–Ω–µ–π–Ω–∞—è –º–æ–¥–µ–ª—å
lr = LinearRegression()
lr.fit(X, y_revenue)
y_pred_linear = lr.predict(X)
r2_linear = r2_score(y_revenue, y_pred_linear)

# 2. –ü–æ–ª–∏–Ω–æ–º–∏–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å (2-–π —Å—Ç–µ–ø–µ–Ω–∏)
poly = PolynomialFeatures(degree=2)
X_poly = poly.fit_transform(X)
lr_poly = LinearRegression()
lr_poly.fit(X_poly, y_revenue)
y_pred_poly = lr_poly.predict(X_poly)
r2_poly = r2_score(y_revenue, y_pred_poly)

# 3. –õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –∫—Ä–∏–≤–∞—è (–∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏—è —á–µ—Ä–µ–∑ –ø–æ–ª–∏–Ω–æ–º 3-–π —Å—Ç–µ–ø–µ–Ω–∏)
poly3 = PolynomialFeatures(degree=3)
X_poly3 = poly3.fit_transform(X)
lr_poly3 = LinearRegression()
lr_poly3.fit(X_poly3, y_revenue)
y_pred_poly3 = lr_poly3.predict(X_poly3)
r2_poly3 = r2_score(y_revenue, y_pred_poly3)

print(f"R¬≤ –º–æ–¥–µ–ª–µ–π:")
print(f"  ‚Ä¢ –õ–∏–Ω–µ–π–Ω–∞—è: {r2_linear:.3f}")
print(f"  ‚Ä¢ –ö–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞—è: {r2_poly:.3f}")
print(f"  ‚Ä¢ –ö—É–±–∏—á–µ—Å–∫–∞—è: {r2_poly3:.3f}")

# –ü–æ–∏—Å–∫ –æ–ø—Ç–∏–º—É–º–∞ –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–π –º–æ–¥–µ–ª–∏
# y = a + b*x + c*x¬≤ ‚Üí –º–∞–∫—Å–∏–º—É–º –ø—Ä–∏ x = -b/(2c)
if r2_poly > r2_linear and len(lr_poly.coef_) >= 3:
    a, b, c = lr_poly.coef_[0], lr_poly.coef_[1], lr_poly.coef_[2]
    if c < 0:  # –ü–∞—Ä–∞–±–æ–ª–∞ –≤–Ω–∏–∑ (–µ—Å—Ç—å –º–∞–∫—Å–∏–º—É–º)
        optimal_area_method2 = -b / (2 * c)
        print(f"\nüí° –í–´–í–û–î –ú–ï–¢–û–î–ê 2:")
        print(f"  ‚Ä¢ –ú–æ–¥–µ–ª—å: –ö–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞—è (y = {a:.0f} + {b:.0f}*x + {c:.2f}*x¬≤)")
        print(f"  ‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å (—Ç–æ—á–∫–∞ –º–∞–∫—Å–∏–º—É–º–∞): {optimal_area_method2:.0f} –º¬≤")

        # –†–∞—Å—á—ë—Ç –ø—Ä–µ–¥–µ–ª—å–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        areas = np.arange(X.min(), X.max(), 10)
        revenues = lr_poly.predict(poly.transform(areas.reshape(-1, 1)))
        marginal_revenue = np.gradient(revenues, areas)

        # –¢–æ—á–∫–∞, –≥–¥–µ –ø—Ä–µ–¥–µ–ª—å–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ –ø–∞–¥–∞–µ—Ç –Ω–∞ 50% –æ—Ç –º–∞–∫—Å.
        threshold_idx = np.where(marginal_revenue < marginal_revenue.max() * 0.5)[0]
        if len(threshold_idx) > 0:
            diminishing_point = areas[threshold_idx[0]]
            print(f"  ‚Ä¢ –¢–æ—á–∫–∞ —É–±—ã–≤–∞—é—â–µ–π –æ—Ç–¥–∞—á–∏ (50% –æ—Ç –º–∞–∫—Å): {diminishing_point:.0f} –º¬≤")
    else:
        optimal_area_method2 = X.mean()
        print(f"\nüí° –í–´–í–û–î –ú–ï–¢–û–î–ê 2:")
        print(f"  ‚Ä¢ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –ª–∏–Ω–µ–π–Ω–∞—è, –º–∞–∫—Å–∏–º—É–º –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω")
        print(f"  ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –ø–ª–æ—â–∞–¥—å (—Å—Ä–µ–¥–Ω–µ–µ): {optimal_area_method2:.0f} –º¬≤")
else:
    optimal_area_method2 = X.mean()
    print(f"\nüí° –í–´–í–û–î –ú–ï–¢–û–î–ê 2:")
    print(f"  ‚Ä¢ –õ—É—á—à–∞—è –º–æ–¥–µ–ª—å: –õ–∏–Ω–µ–π–Ω–∞—è (–ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –æ—Ç–¥–∞—á–∞ –æ—Ç –ø–ª–æ—â–∞–¥–∏)")
    print(f"  ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –ø–ª–æ—â–∞–¥—å (—Å—Ä–µ–¥–Ω–µ–µ): {optimal_area_method2:.0f} –º¬≤")

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
fig = go.Figure()

fig.add_trace(go.Scatter(
    x=store_with_area['–ü–ª–æ—â–∞–¥—å_–º2'],
    y=store_with_area['–í—ã—Ä—É—á–∫–∞'],
    mode='markers',
    name='–§–∞–∫—Ç',
    marker=dict(size=10, color='blue')
))

# –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–∏–Ω–∏–π
X_sorted = np.sort(X.flatten())
fig.add_trace(go.Scatter(
    x=X_sorted,
    y=lr.predict(X_sorted.reshape(-1, 1)),
    mode='lines',
    name=f'–õ–∏–Ω–µ–π–Ω–∞—è (R¬≤={r2_linear:.2f})',
    line=dict(dash='dash', color='green')
))

fig.add_trace(go.Scatter(
    x=X_sorted,
    y=lr_poly.predict(poly.transform(X_sorted.reshape(-1, 1))),
    mode='lines',
    name=f'–ö–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞—è (R¬≤={r2_poly:.2f})',
    line=dict(color='red', width=3)
))

# –õ–∏–Ω–∏—è –æ–ø—Ç–∏–º—É–º–∞
if 'optimal_area_method2' in locals():
    fig.add_vline(x=optimal_area_method2, line_dash="dot", line_color="orange",
                  annotation_text=f"–û–ø—Ç–∏–º—É–º: {optimal_area_method2:.0f} –º¬≤")

fig.update_layout(
    title='üìà –ú–µ—Ç–æ–¥ 2: –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—ã—Ä—É—á–∫–∏ –æ—Ç –ø–ª–æ—â–∞–¥–∏',
    xaxis_title='–ü–ª–æ—â–∞–¥—å (–º¬≤)',
    yaxis_title='–í—ã—Ä—É—á–∫–∞ (—Ä—É–±)',
    height=500
)
fig.show()


# ============================================================
# –ú–ï–¢–û–î 3: –ü–†–ï–î–ï–õ–¨–ù–ê–Ø –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨ (–ú–ê–†–ñ–ò–ù–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó)
# ============================================================

print("\n" + "="*80)
print("üíπ –ú–ï–¢–û–î 3: –ü–†–ï–î–ï–õ–¨–ù–ê–Ø –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨")
print("="*80)
print("–¶–µ–ª—å: –ù–∞–π—Ç–∏ –ø–ª–æ—â–∞–¥—å, –≥–¥–µ –ø—Ä–µ–¥–µ–ª—å–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–∞–¥–∞—Ç—å\n")

# –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–∞–≥–∞–∑–∏–Ω—ã –ø–æ –ø–ª–æ—â–∞–¥–∏
marginal_df = store_with_area.sort_values('–ü–ª–æ—â–∞–¥—å_–º2').copy()

# –†–∞—Å—á—ë—Ç –ø—Ä–µ–¥–µ–ª—å–Ω–æ–π –≤—ã—Ä—É—á–∫–∏ (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Ä—É—á–∫–∏ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–ª–æ—â–∞–¥–∏)
marginal_df['Delta_Area'] = marginal_df['–ü–ª–æ—â–∞–¥—å_–º2'].diff()
marginal_df['Delta_Revenue'] = marginal_df['–í—ã—Ä—É—á–∫–∞'].diff()
marginal_df['Marginal_Revenue'] = marginal_df['Delta_Revenue'] / marginal_df['Delta_Area']

# –°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
marginal_df['Marginal_Revenue_MA'] = marginal_df['Marginal_Revenue'].rolling(3, min_periods=1).mean()

# –ù–∞—Ö–æ–¥–∏–º —Ç–æ—á–∫—É, –≥–¥–µ –ø—Ä–µ–¥–µ–ª—å–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç —É—Å—Ç–æ–π—á–∏–≤–æ –ø–∞–¥–∞—Ç—å
peak_idx = marginal_df['Marginal_Revenue_MA'].idxmax()
optimal_area_method3 = marginal_df.loc[peak_idx, '–ü–ª–æ—â–∞–¥—å_–º2'] if not pd.isna(peak_idx) else marginal_df['–ü–ª–æ—â–∞–¥—å_–º2'].median()

print("üìä –ü—Ä–µ–¥–µ–ª—å–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ –ø–æ –ø–ª–æ—â–∞–¥–∏:")
print(marginal_df[['–ú–∞–≥–∞–∑–∏–Ω', '–ü–ª–æ—â–∞–¥—å_–º2', '–í—ã—Ä—É—á–∫–∞', 'Marginal_Revenue', 'Marginal_Revenue_MA']].round(0))

print(f"\nüí° –í–´–í–û–î –ú–ï–¢–û–î–ê 3:")
print(f"  ‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å (–ø–∏–∫ –ø—Ä–µ–¥–µ–ª—å–Ω–æ–π –≤—ã—Ä—É—á–∫–∏): {optimal_area_method3:.0f} –º¬≤")
print(f"  ‚Ä¢ –ú–∞–∫—Å. –ø—Ä–µ–¥–µ–ª—å–Ω–∞—è –≤—ã—Ä—É—á–∫–∞: {marginal_df['Marginal_Revenue_MA'].max():.0f} —Ä—É–±/–º¬≤")

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
fig = make_subplots(rows=2, cols=1, subplot_titles=['–í—ã—Ä—É—á–∫–∞ –æ—Ç –ø–ª–æ—â–∞–¥–∏', '–ü—Ä–µ–¥–µ–ª—å–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ (‚àÇRevenue/‚àÇArea)'])

# –ì—Ä–∞—Ñ–∏–∫ 1: –í—ã—Ä—É—á–∫–∞
fig.add_trace(
    go.Scatter(x=marginal_df['–ü–ª–æ—â–∞–¥—å_–º2'], y=marginal_df['–í—ã—Ä—É—á–∫–∞'],
               mode='lines+markers', name='–í—ã—Ä—É—á–∫–∞'),
    row=1, col=1
)

# –ì—Ä–∞—Ñ–∏–∫ 2: –ü—Ä–µ–¥–µ–ª—å–Ω–∞—è –≤—ã—Ä—É—á–∫–∞
fig.add_trace(
    go.Scatter(x=marginal_df['–ü–ª–æ—â–∞–¥—å_–º2'], y=marginal_df['Marginal_Revenue'],
               mode='markers', name='–§–∞–∫—Ç', marker=dict(color='lightgray')),
    row=2, col=1
)

fig.add_trace(
    go.Scatter(x=marginal_df['–ü–ª–æ—â–∞–¥—å_–º2'], y=marginal_df['Marginal_Revenue_MA'],
               mode='lines', name='–¢—Ä–µ–Ω–¥ (MA-3)', line=dict(color='red', width=3)),
    row=2, col=1
)

# –õ–∏–Ω–∏—è –æ–ø—Ç–∏–º—É–º–∞
fig.add_vline(x=optimal_area_method3, line_dash="dash", line_color="green", row=2, col=1,
              annotation_text=f"–û–ø—Ç–∏–º—É–º: {optimal_area_method3:.0f} –º¬≤")

fig.update_layout(height=700, title_text='üíπ –ú–µ—Ç–æ–¥ 3: –ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑')
fig.update_xaxes(title_text="–ü–ª–æ—â–∞–¥—å (–º¬≤)")
fig.update_yaxes(title_text="–í—ã—Ä—É—á–∫–∞ (—Ä—É–±)", row=1, col=1)
fig.update_yaxes(title_text="–ü—Ä–µ–¥–µ–ª—å–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ (—Ä—É–±/–º¬≤)", row=2, col=1)
fig.show()


# ============================================================
# –ú–ï–¢–û–î 4: –ö–õ–ê–°–¢–ï–†–ò–ó–ê–¶–ò–Ø + –ë–ï–ù–ß–ú–ê–†–ö–ò–ù–ì
# ============================================================

print("\n" + "="*80)
print("üéØ –ú–ï–¢–û–î 4: –ö–õ–ê–°–¢–ï–†–ò–ó–ê–¶–ò–Ø –ü–û –†–ê–ó–ú–ï–†–£ + –ë–ï–ù–ß–ú–ê–†–ö–ò–ù–ì")
print("="*80)
print("–¶–µ–ª—å: –†–∞–∑–¥–µ–ª–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω—ã –Ω–∞ —Ä–∞–∑–º–µ—Ä–Ω—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã –∏ –Ω–∞–π—Ç–∏ –ª–∏–¥–µ—Ä–æ–≤ –≤ –∫–∞–∂–¥–æ–º\n")

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã –ø–æ –ø–ª–æ—â–∞–¥–∏ (–∫–≤–∞–Ω—Ç–∏–ª–∏)
store_with_area['–†–∞–∑–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä'] = pd.qcut(
    store_with_area['–ü–ª–æ—â–∞–¥—å_–º2'],
    q=3,
    labels=['–ú–∞–ª—ã–µ', '–°—Ä–µ–¥–Ω–∏–µ', '–ö—Ä—É–ø–Ω—ã–µ'],
    duplicates='drop'
)

# –ê–Ω–∞–ª–∏–∑ –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º
cluster_analysis = store_with_area.groupby('–†–∞–∑–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä').agg({
    '–ü–ª–æ—â–∞–¥—å_–º2': ['min', 'max', 'mean'],
    '–í—ã—Ä—É—á–∫–∞_–Ω–∞_–º2': 'mean',
    '–ü—Ä–∏–±—ã–ª—å_–Ω–∞_–º2': 'mean',
    '–ú–∞–≥–∞–∑–∏–Ω': 'count'
}).round(0)

cluster_analysis.columns = ['_'.join(col).strip() for col in cluster_analysis.columns]
print("üìä –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤:")
display(cluster_analysis)

# –ù–∞—Ö–æ–¥–∏–º –ª–∏–¥–µ—Ä–æ–≤ –≤ –∫–∞–∂–¥–æ–º –∫–ª–∞—Å—Ç–µ—Ä–µ
print("\nüèÜ –õ–∏–¥–µ—Ä—ã –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å/–º¬≤):")
leaders = []
for cluster in store_with_area['–†–∞–∑–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä'].unique():
    cluster_data = store_with_area[store_with_area['–†–∞–∑–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä'] == cluster]
    leader = cluster_data.nlargest(1, '–ü—Ä–∏–±—ã–ª—å_–Ω–∞_–º2').iloc[0]
    leaders.append(leader)
    print(f"\n{cluster}:")
    print(f"  –ú–∞–≥–∞–∑–∏–Ω: {leader['–ú–∞–≥–∞–∑–∏–Ω']}")
    print(f"  –ü–ª–æ—â–∞–¥—å: {leader['–ü–ª–æ—â–∞–¥—å_–º2']:.0f} –º¬≤")
    print(f"  –í—ã—Ä—É—á–∫–∞/–º¬≤: {leader['–í—ã—Ä—É—á–∫–∞_–Ω–∞_–º2']:.0f} —Ä—É–±")
    print(f"  –ü—Ä–∏–±—ã–ª—å/–º¬≤: {leader['–ü—Ä–∏–±—ã–ª—å_–Ω–∞_–º2']:.0f} —Ä—É–±")

# –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å = —Å—Ä–µ–¥–Ω—è—è –ø–ª–æ—â–∞–¥—å –ª–∏–¥–µ—Ä–æ–≤
optimal_area_method4 = np.mean([l['–ü–ª–æ—â–∞–¥—å_–º2'] for l in leaders])

print(f"\nüí° –í–´–í–û–î –ú–ï–¢–û–î–ê 4:")
print(f"  ‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å (—Å—Ä–µ–¥–Ω–µ–µ –ª–∏–¥–µ—Ä–æ–≤): {optimal_area_method4:.0f} –º¬≤")
print(f"  ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º:")
for cluster in store_with_area['–†–∞–∑–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä'].unique():
    cluster_data = store_with_area[store_with_area['–†–∞–∑–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä'] == cluster]
    leader = cluster_data.nlargest(1, '–ü—Ä–∏–±—ã–ª—å_–Ω–∞_–º2').iloc[0]
    print(f"    - {cluster}: –æ—Ä–∏–µ–Ω—Ç–∏—Ä {leader['–ü–ª–æ—â–∞–¥—å_–º2']:.0f} –º¬≤ (—ç—Ç–∞–ª–æ–Ω: {leader['–ú–∞–≥–∞–∑–∏–Ω']})")

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
fig = px.box(
    store_with_area,
    x='–†–∞–∑–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä',
    y='–í—ã—Ä—É—á–∫–∞_–Ω–∞_–º2',
    points='all',
    title='üéØ –ú–µ—Ç–æ–¥ 4: –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —Ä–∞–∑–º–µ—Ä–Ω—ã–º –∫–ª–∞—Å—Ç–µ—Ä–∞–º',
    labels={'–†–∞–∑–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä': '–ö–ª–∞—Å—Ç–µ—Ä', '–í—ã—Ä—É—á–∫–∞_–Ω–∞_–º2': '–í—ã—Ä—É—á–∫–∞ –Ω–∞ –º¬≤ (—Ä—É–±)'},
    color='–†–∞–∑–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä'
)

# –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –ª–∏–¥–µ—Ä–æ–≤
for leader in leaders:
    fig.add_annotation(
        x=leader['–†–∞–∑–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä'],
        y=leader['–í—ã—Ä—É—á–∫–∞_–Ω–∞_–º2'],
        text=f"‚òÖ {leader['–ü–ª–æ—â–∞–¥—å_–º2']:.0f} –º¬≤",
        showarrow=True,
        arrowhead=2
    )

fig.update_layout(height=500)
fig.show()


# ============================================================
# –ò–¢–û–ì–û–í–ê–Ø –°–í–û–î–ö–ê –í–°–ï–• –ú–ï–¢–û–î–û–í
# ============================================================

print("\n" + "="*80)
print("üìã –ò–¢–û–ì–û–í–ê–Ø –°–í–û–î–ö–ê: –û–ü–¢–ò–ú–ê–õ–¨–ù–ê–Ø –ü–õ–û–©–ê–î–¨ –ú–ê–ì–ê–ó–ò–ù–ê")
print("="*80)

results = {
    '–ú–µ—Ç–æ–¥': [
        '1. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ –º¬≤',
        '2. –ù–µ–ª–∏–Ω–µ–π–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è',
        '3. –ü—Ä–µ–¥–µ–ª—å–Ω–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
        '4. –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è + –±–µ–Ω—á–º–∞—Ä–∫–∏–Ω–≥'
    ],
    '–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å (–º¬≤)': [
        optimal_area_method1_profit,
        optimal_area_method2,
        optimal_area_method3,
        optimal_area_method4
    ],
    '–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ': [
        '–°—Ä–µ–¥–Ω—è—è –ø–ª–æ—â–∞–¥—å —Ç–æ–ø-5 –ø–æ –ø—Ä–∏–±—ã–ª–∏/–º¬≤',
        '–¢–æ—á–∫–∞ –º–∞–∫—Å–∏–º—É–º–∞ –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏',
        '–ü–∏–∫ –ø—Ä–µ–¥–µ–ª—å–Ω–æ–π –≤—ã—Ä—É—á–∫–∏',
        '–°—Ä–µ–¥–Ω—è—è –ø–ª–æ—â–∞–¥—å –ª–∏–¥–µ—Ä–æ–≤ –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º'
    ]
}

summary_df = pd.DataFrame(results)
display(summary_df)

# –ò—Ç–æ–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è (–º–µ–¥–∏–∞–Ω–∞ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤)
valid_areas = [a for a in results['–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å (–º¬≤)'] if a is not None]
final_optimal_area = np.median(valid_areas)
final_optimal_range = (np.percentile(valid_areas, 25), np.percentile(valid_areas, 75))

print(f"\nüéØ –§–ò–ù–ê–õ–¨–ù–ê–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:")
print(f"  ‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å: {final_optimal_area:.0f} –º¬≤ (–º–µ–¥–∏–∞–Ω–∞ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤)")
print(f"  ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω: {final_optimal_range[0]:.0f} - {final_optimal_range[1]:.0f} –º¬≤ (25-75 –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å)")
print(f"\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–∏—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤:")
print(f"  ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –ø–ª–æ—â–∞–¥—å: {store_with_area['–ü–ª–æ—â–∞–¥—å_–º2'].mean():.0f} –º¬≤")
print(f"  ‚Ä¢ –ú–µ–¥–∏–∞–Ω–Ω–∞—è –ø–ª–æ—â–∞–¥—å: {store_with_area['–ü–ª–æ—â–∞–¥—å_–º2'].median():.0f} –º¬≤")
print(f"  ‚Ä¢ –î–∏–∞–ø–∞–∑–æ–Ω: {store_with_area['–ü–ª–æ—â–∞–¥—å_–º2'].min():.0f} - {store_with_area['–ü–ª–æ—â–∞–¥—å_–º2'].max():.0f} –º¬≤")

# –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–æ–≤
store_with_area['–°—Ç–∞—Ç—É—Å_–ø–ª–æ—â–∞–¥–∏'] = store_with_area['–ü–ª–æ—â–∞–¥—å_–º2'].apply(
    lambda x: 'üü¢ –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è' if final_optimal_range[0] <= x <= final_optimal_range[1]
              else ('üî¥ –°–ª–∏—à–∫–æ–º –º–∞–ª–∞—è' if x < final_optimal_range[0] else 'üü† –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è')
)

print(f"\nüè™ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É:")
print(store_with_area['–°—Ç–∞—Ç—É—Å_–ø–ª–æ—â–∞–¥–∏'].value_counts())

print(f"\nüí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ú–ê–ì–ê–ó–ò–ù–ê–ú:")
for status in ['üî¥ –°–ª–∏—à–∫–æ–º –º–∞–ª–∞—è', 'üü† –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è']:
    stores = store_with_area[store_with_area['–°—Ç–∞—Ç—É—Å_–ø–ª–æ—â–∞–¥–∏'] == status]
    if len(stores) > 0:
        print(f"\n{status}:")
        for _, store in stores.iterrows():
            delta = final_optimal_area - store['–ü–ª–æ—â–∞–¥—å_–º2']
            action = '—Ä–∞—Å—à–∏—Ä–∏—Ç—å' if delta > 0 else '—Å–æ–∫—Ä–∞—Ç–∏—Ç—å'
            print(f"  ‚Ä¢ {store['–ú–∞–≥–∞–∑–∏–Ω']}: {store['–ü–ª–æ—â–∞–¥—å_–º2']:.0f} –º¬≤ ‚Üí {action} –Ω–∞ {abs(delta):.0f} –º¬≤")

# –§–∏–Ω–∞–ª—å–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
fig = go.Figure()

# Scatter –≤—Å–µ—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤
fig.add_trace(go.Scatter(
    x=store_with_area['–ü–ª–æ—â–∞–¥—å_–º2'],
    y=store_with_area['–í—ã—Ä—É—á–∫–∞_–Ω–∞_–º2'],
    mode='markers+text',
    marker=dict(
        size=15,
        color=store_with_area['–ü—Ä–∏–±—ã–ª—å_–Ω–∞_–º2'],
        colorscale='RdYlGn',
        showscale=True,
        colorbar=dict(title="–ü—Ä–∏–±—ã–ª—å/–º¬≤")
    ),
    text=store_with_area['Store_ID'],
    textposition='top center',
    name='–ú–∞–≥–∞–∑–∏–Ω—ã',
    hovertemplate='<b>%{text}</b><br>–ü–ª–æ—â–∞–¥—å: %{x:.0f} –º¬≤<br>–í—ã—Ä—É—á–∫–∞/–º¬≤: %{y:,.0f} —Ä—É–±<extra></extra>'
))

# –ó–æ–Ω–∞ –æ–ø—Ç–∏–º—É–º–∞
fig.add_vrect(
    x0=final_optimal_range[0], x1=final_optimal_range[1],
    fillcolor="green", opacity=0.1,
    annotation_text="–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω", annotation_position="top left"
)

# –õ–∏–Ω–∏—è –æ–ø—Ç–∏–º—É–º–∞
fig.add_vline(x=final_optimal_area, line_dash="dash", line_color="red", line_width=3,
              annotation_text=f"–û–ø—Ç–∏–º—É–º: {final_optimal_area:.0f} –º¬≤")

fig.update_layout(
    title='üéØ –ò–¢–û–ì–û–í–ê–Ø –ö–ê–†–¢–ê: –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å –º–∞–≥–∞–∑–∏–Ω–∞',
    xaxis_title='–ü–ª–æ—â–∞–¥—å (–º¬≤)',
    yaxis_title='–í—ã—Ä—É—á–∫–∞ –Ω–∞ –º¬≤ (—Ä—É–±)',
    height=600,
    showlegend=True
)

fig.show()

print("\n" + "="*80)
print("‚úì –ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–Å–ù")
print("="*80)
